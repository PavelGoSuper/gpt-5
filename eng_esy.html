<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pronounce Master ‚Äî –≤–∞–Ω–∏–ª—å–Ω—ã–π HTML</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#0b1020; --bg2:#111827; --card:rgba(255,255,255,0.06);
    --border:rgba(255,255,255,0.12); --muted:rgba(255,255,255,0.65);
    --text:#fff; --accent1:#eab308; --accent2:#10b981; --accent3:#60a5fa;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:var(--text); background: radial-gradient(1200px 600px at 20% 0%, #facc1540, transparent),
                        radial-gradient(1000px 600px at 80% 10%, #10b98140, transparent),
                        linear-gradient(135deg,var(--bg1),var(--bg2));
    min-height:100%;
  }
  .grid{max-width:1180px;margin:0 auto;padding:24px;display:grid;gap:24px}
  @media(min-width:980px){.grid{grid-template-columns:1.4fr 1fr}}

  .card{background:var(--card);backdrop-filter: blur(14px); border:1px solid var(--border);
        border-radius:22px; box-shadow:0 10px 40px rgba(0,0,0,0.5)}
  .card .hdr{padding:18px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .card .cnt{padding:18px 20px}

  .title{font-weight:700;font-size:22px;letter-spacing:.2px; background:linear-gradient(90deg,#fde68a,#d1fae5,#bfdbfe); -webkit-background-clip:text; background-clip:text; color:transparent}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:rgba(255,255,255,.05);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}

  .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--border);background:rgba(255,255,255,0.08);color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px;font-weight:600}
  .btn:hover{background:rgba(255,255,255,0.16)}
  .btn.primary{border:0;background:linear-gradient(90deg,#34d399,#fbbf24); color:#0f172a;}
  .btn.primary:hover{filter:brightness(1.05)}
  .btn.danger{background:#fecdd3;color:#0f172a;border:0}
  .muted{color:var(--muted)}
  .big{font-size:clamp(26px,3.4vw,36px);font-weight:700;letter-spacing:.3px;text-shadow:0 2px 10px rgba(0,0,0,.3)}
  .ipa{color:#ffffffb0;font-size:14px}

  .bar{height:8px;background:rgba(255,255,255,0.12);border-radius:999px;overflow:hidden}
  .bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#34d399,#fbbf24); transition:width .2s}

  .box{border:1px solid var(--border);background:rgba(255,255,255,0.06);border-radius:16px;padding:14px}
  .vu{display:flex;gap:6px;align-items:flex-end;height:32px}
  .vu i{width:6px;border-radius:10px;background:linear-gradient(180deg,#fde68a,#34d399);height:6px;transition:height .12s}
  .tabs{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
  .tabs button{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:rgba(255,255,255,0.06);color:#fff;cursor:pointer}
  .tabs button.active{background:linear-gradient(90deg,#34d39922,#fbbf2422); box-shadow: inset 0 0 0 9999px rgba(255,255,255,0.02)}

  .packs{display:flex;flex-wrap:wrap;gap:8px}
  .packs button{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.06);color:#fff;cursor:pointer}
  .packs button.active{background:#86efac;color:#0f172a;border:0}

  input[type="range"]{width:100%}
  input[type="text"],.select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:rgba(255,255,255,0.08);color:#fff;outline:none}

  .list{padding-left:18px}
  .list li{margin:6px 0}
  .right-col{position:sticky;top:18px;height:max-content;display:flex;flex-direction:column;gap:24px}
  .sep{height:1px;background:var(--border);margin:12px 0}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  .stat{display:inline-flex;gap:10px;align-items:center}
  .icon{width:18px;height:18px;display:inline-block}
  .divider{width:1px;height:16px;background:var(--border);margin:0 8px;display:inline-block}
</style>
</head>
<body>
  <main class="grid">
    <section class="card">
      <div class="hdr">
        <div class="stat">
          <span class="icon" aria-hidden="true">‚ú®</span>
          <span class="title">Pronounce&nbsp;Master</span>
          <span class="icon" title="–ì–ª–æ–±—É—Å">üåê</span>
          <span class="chip">premium</span>
        </div>
        <div class="stat">
          <span class="chip">üèÜ <span id="best">0</span></span>
          <span class="chip">‚≠ê <span id="streak">0</span></span>
          <span class="divider"></span>
          <span class="chip">üìö <span id="packName">beginner</span></span>
        </div>
      </div>
      <div class="cnt">
        <div class="tabs">
          <button class="tabBtn active" data-tab="train">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</button>
          <button class="tabBtn" data-tab="custom">–°–≤–æ—è —Ñ—Ä–∞–∑–∞</button>
          <button class="tabBtn" data-tab="settings">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>
        <div class="tab" id="tab-train">
          <div class="row" style="align-items:flex-start">
            <div>
              <div class="muted" style="font-size:14px;margin-bottom:4px">–ü—Ä–æ–∏–∑–Ω–µ—Å–∏—Ç–µ —Ñ—Ä–∞–∑—É</div>
              <div class="big" id="targetText">hello</div>
              <div class="ipa" id="ipa">IPA: h…ôÀàlo ä</div>
            </div>
            <div class="row" style="gap:8px">
              <button class="btn" id="btnPlay">üîä –°–ª—É—à–∞—Ç—å</button>
              <button class="btn primary" id="btnRec">üéôÔ∏è –ó–∞–ø–∏—Å—å</button>
            </div>
          </div>
          <div class="box" style="margin-top:14px">
            <div class="row" style="margin-bottom:8px">
              <div class="muted" style="font-size:14px">Realtime —Å—Ö–æ–∂–µ—Å—Ç—å</div>
              <div id="simPct" style="font-weight:700;color:#a7f3d0;text-shadow:0 0 6px rgba(16,185,129,.35)">0%</div>
            </div>
            <div class="bar"><span id="bar" style="width:0%"></span></div>
            <div id="transcript" style="min-height:38px;margin-top:10px;color:#e5e7eb"></div>
          </div>
          <div class="row" style="margin-top:12px">
            <div class="row" style="gap:8px">
              <button class="btn" id="btnReset">‚Ü∫ –°–±—Ä–æ—Å</button>
              <button class="btn" id="btnResult">üèÖ –†–µ–∑—É–ª—å—Ç–∞—Ç</button>
            </div>
            <button class="btn primary" id="btnNext">‚è≠Ô∏è –î–∞–ª—å—à–µ</button>
          </div>
          <div class="box row" style="margin-top:12px;justify-content:space-between">
            <div class="muted" style="font-size:14px">–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏</div>
            <div class="vu" id="vu">
              <i></i><i></i><i></i><i></i><i></i><i></i><i></i>
              <i></i><i></i><i></i><i></i><i></i><i></i>
            </div>
          </div>
        </div>
        <div class="tab" id="tab-custom" style="display:none">
          <div class="muted" style="font-size:14px;margin-bottom:6px">–í–≤–µ–¥–∏—Ç–µ –ª—é–±—É—é —Ñ—Ä–∞–∑—É –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º –∏ —Ç—Ä–µ–Ω–∏—Ä—É–π—Ç–µ—Å—å</div>
          <input id="customInput" type="text" class="input" placeholder="Type your own phrase‚Ä¶" />
          <div class="big" id="customShown" style="margin-top:6px">‚Äî</div>
          <div class="row" style="gap:8px;margin-top:6px">
            <button class="btn" id="btnPlay2">‚ñ∂Ô∏è –°–ª—É—à–∞—Ç—å</button>
            <button class="btn primary" id="btnRec2">üéôÔ∏è –ó–∞–ø–∏—Å—å</button>
          </div>
          <div class="box" style="margin-top:12px">
            <div class="row" style="margin-bottom:8px">
              <div class="muted" style="font-size:14px">Realtime —Å—Ö–æ–∂–µ—Å—Ç—å</div>
              <div id="simPct2" style="font-weight:700;color:#a7f3d0">0%</div>
            </div>
            <div class="bar"><span id="bar2" style="width:0%"></span></div>
            <div id="transcript2" style="min-height:38px;margin-top:10px;color:#e5e7eb"></div>
          </div>
        </div>
        <div class="tab" id="tab-settings" style="display:none">
          <div class="box">
            <div class="muted" style="margin-bottom:8px">–ù–∞–±–æ—Ä —Å–ª–æ–≤</div>
            <div class="packs" id="packs"></div>
          </div>
          <div class="box" style="margin-top:12px">
            <div class="muted" style="margin-bottom:8px">–ì–æ–ª–æ—Å –∏ —Å–∫–æ—Ä–æ—Å—Ç—å (TTS)</div>
            <select id="voiceSelect" class="select">
              <option value="">Auto (EN)</option>
            </select>
            <label class="muted" style="display:block;margin-top:8px">–°–∫–æ—Ä–æ—Å—Ç—å: <span id="rateVal">0.95</span></label>
            <input id="rate" type="range" min="0.7" max="1.2" step="0.01" value="0.95">
            <label style="display:flex;align-items:center;gap:8px;margin-top:6px">
              <input id="autoplay" type="checkbox" checked> –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–º–µ—Ä–∞
            </label>
          </div>
          <div class="box" style="margin-top:12px">
            <div class="muted" style="margin-bottom:6px">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</div>
            <ol class="list">
              <li>TTS –æ–∑–≤—É—á–∏–≤–∞–µ—Ç —ç—Ç–∞–ª–æ–Ω (Web Speech Synthesis).</li>
              <li>–†–µ—á—å —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ (SpeechRecognition).</li>
              <li>–°—Ö–æ–∂–µ—Å—Ç—å —Å—á–∏—Ç–∞–µ–º –ø–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—é –õ–µ–≤–µ–Ω—à—Ç–µ–π–Ω–∞.</li>
            </ol>
          </div>
        </div>
      </div>
    </section>
    <aside class="right-col">
      <section class="card">
        <div class="hdr"><div class="title" style="font-size:18px;color:#fde68a">–ú–æ—Ç–∏–≤–∞—Ü–∏—è –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ</div></div>
        <div class="cnt">
          <ul class="list">
            <li><b>–û—Ç–∫—Ä–æ–π –º–∏—Ä:</b> –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –¥–∞—ë—Ç –¥–æ—Å—Ç—É–ø –∫ –ª—é–¥—è–º –∏ –∫—É–ª—å—Ç—É—Ä–∞–º –ø–æ –≤—Å–µ–º—É –º–∏—Ä—É.</li>
            <li><b>–£—á–∏—Å—å —É –ª—É—á—à–∏—Ö:</b> —Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –∑–Ω–∞–Ω–∏—è –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ ‚Äî –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.</li>
            <li><b>–ë—É–¥—å –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω:</b> —è–∑—ã–∫ –ø–æ–≤—ã—à–∞–µ—Ç —à–∞–Ω—Å—ã –Ω–∞ –∫–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç.</li>
          </ul>
        </div>
      </section>
      <section class="card">
        <div class="hdr"><div class="title" style="font-size:18px;color:#fde68a">–°–æ–≤–µ—Ç—ã –ø–æ –æ–±—É—á–∞—é—â–µ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É</div></div>
        <div class="cnt">
          <ul class="list">
            <li><b>–ê—Ä—Ç–∏–∫—É–ª—è—Ü–∏—è:</b> –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –ø–æ–ª–æ–∂–µ–Ω–∏–µ –≥—É–±/—è–∑—ã–∫–∞ –∫—Ä—É–ø–Ω—ã–º –ø–ª–∞–Ω–æ–º.</li>
            <li><b>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è:</b> –¥–æ–±–∞–≤–ª—è–π—Ç–µ IPA –∏ –ø–æ–¥—Å–≤–µ—Ç–∫—É –æ—à–∏–±–æ–∫/—É—Å–ø–µ—Ö–æ–≤.</li>
            <li><b>–°—Ä–∞–≤–Ω–µ–Ω–∏–µ:</b> —Ä—è–¥–æ–º –¥–∞–≤–∞–π—Ç–µ —ç—Ç–∞–ª–æ–Ω –∏ –≤–µ—Ä—Å–∏—é —É—á–µ–Ω–∏–∫–∞.</li>
          </ul>
        </div>
      </section>
      <section class="card">
        <div class="hdr"><div class="title" style="font-size:18px;color:#fde68a">–§–∞–∫—Ç—ã (–∫–æ—Ä–æ—Ç–∫–æ)</div></div>
        <div class="cnt">
          <ul class="list">
            <li><b>–ò–Ω—Ç–µ—Ä–Ω–µ—Ç:</b> –ª—å–≤–∏–Ω–∞—è –¥–æ–ª—è –ø—Ä–æ—Ñ–∏–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ ‚Äî –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º.</li>
            <li><b>–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è:</b> –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –ø–æ–º–æ–≥–∞–µ—Ç —Ä–µ—à–∞—Ç—å 95% –±—ã—Ç–æ–≤—ã—Ö –∑–∞–¥–∞—á –∑–∞ —Ä—É–±–µ–∂–æ–º.</li>
            <li><b>–ù–∞–≤—ã–∫–∏:</b> –∏–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–∞ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç –ø–∞–º—è—Ç—å –∏ –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω—É—é –≥–∏–±–∫–æ—Å—Ç—å.</li>
          </ul>
        </div>
      </section>
    </aside>
  </main>
  <dialog id="modal" style="border:1px solid var(--border);background:linear-gradient(135deg,#0f172a,#0b1020);color:#fff;border-radius:16px;max-width:520px">
    <div style="padding:18px 20px">
      <div class="title" style="font-size:20px;margin-bottom:8px">–ò—Ç–æ–≥ –∑–∞ –ø–æ–ø—ã—Ç–∫—É</div>
      <div style="display:grid;gap:8px;color:#e5e7eb">
        <div>–†–∞—Å–ø–æ–∑–Ω–∞–Ω–æ: <span id="mText" class="mono">‚Äî</span></div>
        <div>–°—Ö–æ–∂–µ—Å—Ç—å: <b id="mScore" style="color:#86efac">‚Äî%</b></div>
        <div>–û—á–∫–∏: <b id="mPoints" style="color:#fde68a">0</b></div>
        <div>–°–µ—Ä–∏—è: <b id="mStreak" style="color:#fde68a">0</b></div>
      </div>
      <div style="text-align:right;margin-top:12px">
        <button class="btn" onclick="document.getElementById('modal').close()">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </dialog>
<script>
const PACKS = {
  beginner:[
    { phrase:"hello", hint:"h…ôÀàlo ä" },
    { phrase:"thank you", hint:"Œ∏√¶≈ãk juÀê" },
    { phrase:"good morning", hint:"g äd Ààm…îÀêrn…™≈ã" },
    { phrase:"please", hint:"pliÀêz" },
    { phrase:"sorry", hint:"Ààs…íri / Ààs…ëÀêri" },
  ],
  travel:[
    { phrase:"where is the station?", hint:"we…ô …™z √∞…ô Ààste…™ Én" },
    { phrase:"how much is this?", hint:"ha ä m åt É …™z √∞…™s" },
    { phrase:"I need a ticket", hint:"a…™ niÀêd …ô Ààt…™k…™t" },
    { phrase:"a glass of water, please", hint:"…ô …°l…ëÀês …ôv Ààw…îÀêt…ô" },
    { phrase:"thank you very much", hint:"Œ∏√¶≈ãk juÀê Ààv…õri m åt É" },
  ],
  business:[
    { phrase:"let's schedule a meeting", hint:"lets Ààsked íuÀêl …ô ÀàmiÀêt…™≈ã" },
    { phrase:"could you share the report?", hint:"k äd ju  Ée…ô √∞…ô r…™Ààp…îÀêt" },
    { phrase:"I'll get back to you", hint:"a…™l …°et b√¶k t…ô juÀê" },
    { phrase:"deadline is tomorrow", hint:"Ààdedla…™n …™z t…ôÀàm…ír…ô ä" },
    { phrase:"great job, team", hint:"…°re…™t d í…íb tiÀêm" },
  ],
};

let pack = 'beginner', index = 0, voiceName = '', rate = 0.95, autoplay = true;
let score = 0, streak = 0, best = Number(localStorage.getItem('pm_best')||0);
let listening = false, transcriptText = '';

// ==== –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å—Ö–æ–¥—Å—Ç–≤–æ ====
function levenshtein(a,b){
  const m=a.length,n=b.length; const dp=Array.from({length:m+1},()=>new Array(n+1).fill(0));
  for(let i=0;i<=m;i++)dp[i][0]=i; for(let j=0;j<=n;j++)dp[0][j]=j;
  for(let i=1;i<=m;i++)for(let j=1;j<=n;j++){ const cost=a[i-1]===b[j-1]?0:1;
    dp[i][j]=Math.min(dp[i-1][j]+1,dp[i][j-1]+1,dp[i-1][j-1]+cost); }
  return dp[m][n];
}
const NON_EN_RE = new RegExp("[^a-z ']+","g");
const WS_RE     = new RegExp("[\t\n\r\f ]+","g");
const norm = t => t.toLowerCase().replace(NON_EN_RE,"").replace(WS_RE," ").trim();
function simil(a,b){
  const A=norm(a), B=norm(b); if(!A && !B) return 1;
  const d=levenshtein(A,B); const L=Math.max(A.length,B.length)||1; return 1 - d/L;
}

// ==== –£—Ç–∏–ª–∏—Ç—ã ====
function qs(id){ return document.getElementById(id) }
function setText(id, v){ qs(id).textContent = v }

// ==== TTS —Å –∑–∞—â–∏—Ç–æ–π –ø–æ –∂–µ—Å—Ç—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ====
let userActivated = false;
window.addEventListener('click', () => { userActivated = true; }, { once: true });

function speak(text){
  if(!('speechSynthesis' in window)) return;
  const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = rate;
  if(voiceName){ const v = window.speechSynthesis.getVoices().find(x=>x.name===voiceName); if(v) u.voice = v; }
  window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
}
// –≤—ã–∑—ã–≤–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–æ–≤ (–±–µ–∑ –∫–ª–∏–∫–∞)
function speakGuarded(text){
  if(!userActivated) return;
  speak(text);
}

// ==== SpeechRecognition ====
let rec = null;

(async function initSR(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){ console.warn('SpeechRecognition not supported'); return; }
  rec = new SR(); rec.lang = 'en-US'; rec.interimResults = true; rec.continuous = false; rec.maxAlternatives = 1;

  rec.onresult = (e)=>{ let t=''; for(let i=e.resultIndex;i<e.results.length;i++) t += e.results[i][0].transcript; transcriptText = t; renderLive(); };
  rec.onend = ()=>{ listening=false; updateVU(false); };
  rec.onerror = (e)=>{ listening=false; updateVU(false);
    const msg = '–û—à–∏–±–∫–∞: ' + e.error + (e.message ? (' ‚Äî ' + e.message) : '');
    setText('transcript', msg); setText('transcript2', msg);
  };
  rec.onnomatch = ()=>{ setText('transcript','–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ'); setText('transcript2','–ù–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–æ'); };
})();

async function ensureMic(){
  try{
    await navigator.mediaDevices.getUserMedia({ audio: true });
    return true;
  }catch(e){
    alert('–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ –±—Ä–∞—É–∑–µ—Ä–∞.');
    return false;
  }
}

async function startRec(){
  if(!rec) return;
  if(!(await ensureMic())) return;
  transcriptText=''; listening=true; updateVU(true);
  try{ rec.start(); }catch(e){}
}
function stopRec(){ if(!rec) return; try{rec.stop();}catch(e){} }

// ==== –†–µ–Ω–¥–µ—Ä—ã –∏ –ª–æ–≥–∏–∫–∞ ====
function currentWord(){ const list = PACKS[pack]; return list[index % list.length]; }
function refreshHeader(){ setText('best', best); setText('streak', streak); setText('packName', pack); }
function renderWord(){ const cur = currentWord(); setText('targetText', cur.phrase); setText('ipa', 'IPA: ' + (cur.hint || '‚Äî')); }
function renderLive(){
  const target = getTargetText(); const s = Math.round(simil(transcriptText, target) * 100);
  setText('simPct', s + '%'); qs('bar').style.width = s + '%';
  setText('transcript', transcriptText || (listening ? '–°–ª—É—à–∞—é‚Ä¶' : '–ù–∞–∂–º–∏—Ç–µ –ó–∞–ø–∏—Å—å –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ'));
  setText('simPct2', s + '%'); qs('bar2').style.width = s + '%';
  setText('transcript2', transcriptText || (listening ? '–°–ª—É—à–∞—é‚Ä¶' : '–ù–∞–∂–º–∏—Ç–µ –ó–∞–ø–∏—Å—å –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ'));
}
function getTargetText(){ const custom = qs('customInput').value.trim();
  if(qs('tab-custom').style.display !== 'none' && custom) return custom; return currentWord().phrase; }

function next(){
  index++; transcriptText=''; renderWord(); renderLive();
  if(autoplay) speakGuarded(currentWord().phrase);
}
function resetAll(){ score=0; streak=0; index=0; transcriptText=''; renderWord(); renderLive(); refreshHeader(); }
function showResult(){
  const s = Math.round(simil(transcriptText, getTargetText()) * 100); if(!Number.isFinite(s)) return;
  if(s>=85){ score += s; streak++; } else { streak=0; }
  if(s>best){ best=s; localStorage.setItem('pm_best', String(best)); }
  setText('mText', transcriptText || '‚Äî'); setText('mScore', s + '%'); setText('mPoints', score); setText('mStreak', streak);
  refreshHeader(); qs('modal').showModal();
}

// ==== –ê–Ω–∏–º–∞—Ü–∏—è VU ====
let vuTimer = null;
function updateVU(on){
  const bars = [...qs('vu').children];
  if(on){ if(vuTimer) return;
    vuTimer = setInterval(()=>{ const t = Date.now();
      bars.forEach((el,i)=>{ const h = 6 + Math.abs(Math.sin((t/180)+(i*0.35))) * 26; el.style.height = h+'px'; });
    }, 110);
  }else{ clearInterval(vuTimer); vuTimer=null; bars.forEach(el=> el.style.height='6px'); }
}

// ==== –¢–∞–±—ã/–ü–∞–∫–∏ ====
document.querySelectorAll('.tabBtn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabBtn').forEach(b=>b.classList.toggle('active', b===btn));
    const tab = btn.dataset.tab;
    ['train','custom','settings'].forEach(id=>{ qs('tab-'+id).style.display = (id===tab)?'block':'none'; });
    if(tab==='train' && autoplay) speakGuarded(currentWord().phrase);
  });
});

(function buildPacks(){
  const c = qs('packs'); c.innerHTML='';
  Object.keys(PACKS).forEach(k=>{
    const b = document.createElement('button'); b.textContent = k; b.className='';
    b.onclick = ()=>{
      pack = k; index=0; document.querySelectorAll('#packs button').forEach(x=>x.classList.remove('active'));
      b.classList.add('active'); renderWord(); refreshHeader();
      if(autoplay) speakGuarded(currentWord().phrase);
    };
    if(k===pack) b.classList.add('active'); c.appendChild(b);
  });
})();

// ==== Voices ====
function populateVoices(){
  const sel = qs('voiceSelect');
  const voices = window.speechSynthesis.getVoices().filter(v=>v.lang && v.lang.startsWith('en'));
  sel.querySelectorAll('option:not([value=""])').forEach(o=>o.remove());
  voices.forEach(v=>{ const o = document.createElement('option'); o.value=v.name; o.textContent=v.name; sel.appendChild(o); });
}
if('speechSynthesis' in window){ populateVoices(); window.speechSynthesis.onvoiceschanged = populateVoices; }

// ==== –ö–Ω–æ–ø–∫–∏ ====
qs('btnPlay').onclick  = ()=> speak(currentWord().phrase);     // –∫–ª–∏–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Äî –º–æ–∂–Ω–æ –±–µ–∑ guard
qs('btnRec').onclick   = ()=> listening ? stopRec() : startRec();
qs('btnNext').onclick  = next;
qs('btnReset').onclick = resetAll;
qs('btnResult').onclick= showResult;
qs('btnPlay2').onclick = ()=> speak(getTargetText());
qs('btnRec2').onclick  = ()=> listening ? stopRec() : startRec();

qs('customInput').addEventListener('input', ()=>{ setText('customShown', qs('customInput').value.trim() || '‚Äî'); renderLive(); });
qs('rate').addEventListener('input', e=>{ rate = parseFloat(e.target.value); setText('rateVal', rate.toFixed(2)); });
qs('autoplay').addEventListener('change', e=> autoplay = e.target.checked);
qs('voiceSelect').addEventListener('change', e=> voiceName = e.target.value);

// ==== Init ====
(function init(){
  setText('best', best); renderWord(); renderLive(); refreshHeader();
  setText('transcript','–ù–∞–∂–º–∏—Ç–µ –ó–∞–ø–∏—Å—å –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ'); setText('transcript2','–ù–∞–∂–º–∏—Ç–µ –ó–∞–ø–∏—Å—å –∏ –≥–æ–≤–æ—Ä–∏—Ç–µ');
  // –ù–µ –æ–∑–≤—É—á–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  if(autoplay && userActivated) speakGuarded(currentWord().phrase);
})();
</script>

</body>
</html>
